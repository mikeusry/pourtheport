---
import CloudinaryImage from '../components/CloudinaryImage.astro';
import ShopifyBuyButtonProduct from '../components/ShopifyBuyButtonProduct.astro';
import GoogleAnalytics from '../components/GoogleAnalytics.astro';
import ConversionTracking from '../components/ConversionTracking.astro';
import KlaviyoReviews from '../components/KlaviyoReviews.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import { getProduct, mockProduct, isShopifyConfigured, getDefaultVariant, formatPrice } from '../lib/shopify';
import '../styles/global.css';

// Fetch product data
let product = mockProduct;
let defaultVariant = getDefaultVariant(mockProduct);

if (isShopifyConfigured()) {
  try {
    const shopifyProduct = await getProduct();
    if (shopifyProduct) {
      product = shopifyProduct;
      defaultVariant = getDefaultVariant(shopifyProduct);
    }
  } catch (error) {
    console.warn('Failed to fetch Shopify product, using mock data:', error);
  }
}

const productPrice = defaultVariant?.price.amount || '84.00';
const formattedPrice = formatPrice(productPrice);
const perTreatmentPrice = formatPrice((parseFloat(productPrice) / 3).toString());
const variantId = defaultVariant?.id || '';

const title = `${product.title} - USDA Certified Biobased® Septic Treatment`;
const description = `${product.description} Professional-grade septic system protection used by National Parks for over 10 years.`;
const canonicalURL = new URL(Astro.url.pathname, Astro.site || 'https://www.pourtheport.com');
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />
    
    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="product" />
    
    <!-- Product Schema -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Product",
        "name": product.title,
        "description": product.description,
        "image": "https://res.cloudinary.com/southland-organics/image/upload/w_800,h_800,c_fill,q_auto/pour-the-port/Pour_the_Port_product",
        "offers": {
          "@type": "Offer",
          "price": productPrice,
          "priceCurrency": "USD",
          "availability": "https://schema.org/InStock",
          "url": "https://pourtheport.com/product"
        },
        "brand": {
          "@type": "Brand",
          "name": "Pour the PORT"
        }
      }
    </script>
    
    <!-- Google Analytics 4 -->
    <GoogleAnalytics />
  </head>

  <body class="bg-gray-50">
    <!-- Main Navigation -->
    <Navigation />
    
    <!-- Breadcrumb Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-16 z-40">
      <div class="container mx-auto px-4 py-3">
        <div class="flex items-center space-x-2 text-sm">
          <a href="/" class="text-gray-500 hover:text-gray-700">Home</a>
          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
          <span class="text-gray-900 font-medium">Product</span>
        </div>
      </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
      <!-- Product Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-16">
        
        <!-- Product Images Gallery -->
        <div class="space-y-4">
          <!-- Main Product Image -->
          <div class="aspect-square bg-white rounded-2xl shadow-lg overflow-hidden">
            <CloudinaryImage
              publicId="pour-the-port/Pour_the_Port_product"
              alt="Pour the PORT septic tank treatment 3-pack annual supply subscription"
              width={600}
              height={600}
              loading="eager"
              preset="product"
              class="w-full h-full object-contain"
            />
          </div>
          
          <!-- Thumbnail Gallery -->
          <div class="grid grid-cols-4 gap-4">
            <div class="aspect-square bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow">
              <CloudinaryImage
                publicId="pour-the-port/Pour_the_Port_product"
                alt="Pour the PORT bacterial septic treatment product packaging"
                width={150}
                height={150}
                preset="thumbnail"
                class="w-full h-full object-contain"
              />
            </div>
            <div class="aspect-square bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow">
              <CloudinaryImage
                publicId="pour-the-port/Carbon"
                alt="Natural septic solution active carbon formula for odor control"
                width={150}
                height={150}
                preset="thumbnail"
                class="w-full h-full object-contain"
              />
            </div>
            <div class="aspect-square bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow">
              <CloudinaryImage
                publicId="pour-the-port/Microbes"
                alt="Beneficial septic tank bacteria microbes for waste decomposition"
                width={150}
                height={150}
                preset="thumbnail"
                class="w-full h-full object-contain"
              />
            </div>
            <div class="aspect-square bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow">
              <CloudinaryImage
                publicId="pour-the-port/Organic_acids"
                alt="Septic system additive organic acids prevent biofilm buildup"
                width={150}
                height={150}
                preset="thumbnail"
                class="w-full h-full object-contain"
              />
            </div>
          </div>
        </div>

        <!-- Product Information -->
        <div class="space-y-6">
          <!-- Product Title & Price -->
          <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">{product.title}</h1>
            <p class="text-gray-600 mb-4">USDA Certified Biobased® • Professional Grade • 3 Treatments</p>
            
            <div class="flex items-baseline space-x-4 mb-6">
              <span class="text-4xl font-bold text-green-600">{formattedPrice}</span>
              <span class="text-lg text-gray-500">for complete year</span>
              <span class="bg-green-100 text-green-800 text-sm font-medium px-3 py-1 rounded-full">
                Save $700+ vs disasters
              </span>
            </div>
          </div>

          <!-- Trust Badges -->
          <div class="flex items-center space-x-4 py-4 border-y border-gray-200">
            <div class="flex items-center text-sm text-gray-600">
              <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
              </svg>
              Fast Shipping
            </div>
            <div class="flex items-center text-sm text-gray-600">
              <svg class="w-5 h-5 text-purple-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
              </svg>
              Eco-Friendly
            </div>
            <div class="flex items-center text-sm text-gray-600">
              <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.031 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
              </svg>
              USDA Certified
            </div>
          </div>

          <!-- Quantity & Add to Cart -->
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
              <div class="flex items-center space-x-3">
                <button class="quantity-btn minus-btn bg-gray-200 hover:bg-gray-300 text-gray-700 w-10 h-10 rounded-full flex items-center justify-center transition-colors">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                  </svg>
                </button>
                <input type="number" id="quantity-input" value="1" min="1" max="10" class="w-20 text-center border border-gray-300 rounded-lg py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                <button class="quantity-btn plus-btn bg-gray-200 hover:bg-gray-300 text-gray-700 w-10 h-10 rounded-full flex items-center justify-center transition-colors">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Add to Cart Buttons -->
            <div class="space-y-3">
              <ShopifyBuyButtonProduct 
                variantId={variantId}
                quantity={1}
                text="Add to Cart - Buy Now"
                class="w-full text-center"
                size="lg"
                style="primary"
              />
              
              <button class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-full transition-colors border border-gray-300">
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
                Save to Wishlist
              </button>
            </div>
          </div>

          <!-- Key Benefits -->
          <div class="bg-green-50 border border-green-200 rounded-xl p-6">
            <h3 class="font-bold text-green-800 mb-3">Why Choose Pour the PORT?</h3>
            <ul class="space-y-2">
              <li class="flex items-center text-green-700">
                <svg class="w-4 h-4 mr-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Prevents $15,000+ septic system failures
              </li>
              <li class="flex items-center text-green-700">
                <svg class="w-4 h-4 mr-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Trusted by National Parks for 10+ years
              </li>
              <li class="flex items-center text-green-700">
                <svg class="w-4 h-4 mr-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Only {perTreatmentPrice} per treatment (3x per year)
              </li>
              <li class="flex items-center text-green-700">
                <svg class="w-4 h-4 mr-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                100% natural bacteria - safe for families & pets
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Product Details Tabs -->
      <div class="bg-white rounded-2xl shadow-lg">
        <div class="border-b border-gray-200">
          <nav class="flex space-x-8 px-8" aria-label="Tabs">
            <button class="tab-button active py-4 px-1 border-b-2 border-green-500 font-medium text-sm text-green-600" data-tab="description">
              Description
            </button>
            <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="usage">
              How to Use
            </button>
            <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="reviews">
              Reviews (127)
            </button>
            <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="shipping">
              Shipping
            </button>
          </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-8">
          <!-- Description Tab -->
          <div id="description-content" class="tab-content">
            <div class="prose max-w-none">
              <p class="text-lg text-gray-700 mb-6">{product.description}</p>
              
              <h3 class="text-xl font-bold text-gray-900 mb-4">Professional-Grade Protection</h3>
              <p class="text-gray-700 mb-6">
                Pour the PORT is the same USDA Certified Biobased® formula trusted by National Parks, universities, and critical infrastructure for over a decade. Our advanced bacterial blend restores the natural biological balance in your septic system, preventing the dangerous buildup that leads to expensive failures.
              </p>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="text-center">
                  <div class="bg-green-100 text-green-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 8.172V5L8 4z"></path>
                    </svg>
                  </div>
                  <h4 class="font-semibold text-gray-900">Natural Formula</h4>
                  <p class="text-sm text-gray-600">Billions of beneficial bacteria per packet</p>
                </div>
                
                <div class="text-center">
                  <div class="bg-blue-100 text-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.031 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                  </div>
                  <h4 class="font-semibold text-gray-900">USDA Certified</h4>
                  <p class="text-sm text-gray-600">Biobased® environmental standard</p>
                </div>
                
                <div class="text-center">
                  <div class="bg-purple-100 text-purple-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                  </div>
                  <h4 class="font-semibold text-gray-900">Fast Acting</h4>
                  <p class="text-sm text-gray-600">Bacteria multiply within 24-48 hours</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Usage Tab -->
          <div id="usage-content" class="tab-content hidden">
            <h3 class="text-xl font-bold text-gray-900 mb-6">Simple 3-Step Process</h3>
            
            <div class="space-y-8">
              <div class="flex items-start space-x-4">
                <div class="bg-green-500 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">1</div>
                <div>
                  <h4 class="text-lg font-semibold text-gray-900 mb-2">Pour Into Toilet</h4>
                  <p class="text-gray-700">Empty entire contents of one packet directly into any toilet. No measuring or mixing required.</p>
                </div>
              </div>
              
              <div class="flex items-start space-x-4">
                <div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">2</div>
                <div>
                  <h4 class="text-lg font-semibold text-gray-900 mb-2">Flush & Forget</h4>
                  <p class="text-gray-700">Give it one good flush. Bacteria immediately begin working in your septic tank.</p>
                </div>
              </div>
              
              <div class="flex items-start space-x-4">
                <div class="bg-purple-500 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">3</div>
                <div>
                  <h4 class="text-lg font-semibold text-gray-900 mb-2">Stay Protected</h4>
                  <p class="text-gray-700">Enjoy 4 months of protection. Repeat 3 times per year (January, May, September).</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Reviews Tab -->
          <div id="reviews-content" class="tab-content hidden">
            <KlaviyoReviews />
          </div>

          <!-- Shipping Tab -->
          <div id="shipping-content" class="tab-content hidden">
            <h3 class="text-xl font-bold text-gray-900 mb-6">Shipping Information</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div>
                <h4 class="font-semibold text-gray-900 mb-3">Shipping Options</h4>
                <ul class="space-y-2 text-gray-700">
                  <li>• Standard Shipping: 5-7 business days</li>
                  <li>• Expedited Shipping: 2-3 business days</li>
                  <li>• Express Shipping: 1-2 business days</li>
                </ul>
              </div>
              
              <div>
                <h4 class="font-semibold text-gray-900 mb-3">Shipping Information</h4>
                <ul class="space-y-2 text-gray-700">
                  <li>• Secure packaging</li>
                  <li>• Tracking provided for all orders</li>
                  <li>• Ships within 1-2 business days</li>
                  <li>• Questions? Call 1-800-608-3755</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Trust Logos -->
      <div class="mt-16 text-center">
        <h3 class="text-2xl font-bold text-gray-900 mb-8">Trusted By Leading Organizations</h3>
        <div class="flex justify-center items-center space-x-8 md:space-x-12 opacity-70">
          <div class="w-24 h-20 md:w-32 md:h-24 flex items-center justify-center">
            <CloudinaryImage
              publicId="pour-the-port/logos/NPS_768_mqklvq"
              alt="National Parks Service trusts Pour the PORT septic treatment"
              width={160}
              height={120}
              preset="logo"
              placeholder={false}
              class="w-full h-full object-contain"
            />
          </div>
          <div class="w-24 h-20 md:w-32 md:h-24 flex items-center justify-center">
            <CloudinaryImage
              publicId="pour-the-port/logos/UGA_xkrnsx"
              alt="University of Georgia endorses bacterial septic treatment"
              width={160}
              height={120}
              preset="logo"
              placeholder={false}
              class="w-full h-full object-contain"
            />
          </div>
          <div class="w-24 h-20 md:w-32 md:h-24 flex items-center justify-center">
            <CloudinaryImage
              publicId="pour-the-port/logos/USFS_mhiaqm"
              alt="US Forest Service uses natural septic solutions"
              width={160}
              height={120}
              placeholder={false}
              preset="logo"
              class="max-w-full max-h-full object-contain"
            />
          </div>
        </div>
      </div>
    </main>

    <script is:inline>
      // Tab functionality
      document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(function(button) {
          button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            // Remove active class from all buttons and hide all contents
            tabButtons.forEach(function(btn) {
              btn.classList.remove('active', 'border-green-500', 'text-green-600');
              btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            tabContents.forEach(function(content) {
              content.classList.add('hidden');
            });
            
            // Add active class to clicked button and show corresponding content
            this.classList.add('active', 'border-green-500', 'text-green-600');
            this.classList.remove('border-transparent', 'text-gray-500');
            
            const targetContent = document.getElementById(tabId + '-content');
            if (targetContent) {
              targetContent.classList.remove('hidden');
            }
          });
        });

        // Quantity controls
        const quantityInput = document.getElementById('quantity-input');
        const minusBtn = document.querySelector('.minus-btn');
        const plusBtn = document.querySelector('.plus-btn');

        if (minusBtn && quantityInput) {
          minusBtn.addEventListener('click', function() {
            const currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
              quantityInput.value = (currentValue - 1).toString();
            }
          });
        }

        if (plusBtn && quantityInput) {
          plusBtn.addEventListener('click', function() {
            const currentValue = parseInt(quantityInput.value);
            if (currentValue < 10) {
              quantityInput.value = (currentValue + 1).toString();
            }
          });
        }

        // Update Shopify button quantities
        if (quantityInput) {
          quantityInput.addEventListener('change', function() {
            const quantity = parseInt(this.value) || 1;
            const shopifyButtons = document.querySelectorAll('.shopify-buy-button');
            shopifyButtons.forEach(function(button) {
              button.setAttribute('data-quantity', quantity.toString());
            });
          });
        }
      });
    </script>

    <Footer />

    <!-- Conversion Tracking -->
    <ConversionTracking />
  </body>
</html>